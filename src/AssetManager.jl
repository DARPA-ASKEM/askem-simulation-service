module AssetManager

import DataFrames: DataFrame
import CSV: read, write
import OpenAPI.Clients: Client
import APIClient: upload_file_datasets_id_file_post, 
                  #get_csv_from_dataset_datasets_id_file_get,
                  create_dataset_datasets_post as init_dataset,
                  Dataset,
                  DatasetsApi

include("./Settings.jl"); import .Settings: settings

api = DatasetsApi(Client(settings["TDS_URL"]))

function get_dataset(dataset_id::Int64)
    url = "$(settings["TDS_URL"])/datasets/$dataset_id/file"
    io = IOStream
    download(url, io)
    read(io, DataFrame)
end

function upload(output::DataFrame)
    # TODO(five): Stream so there isn't duplication in buffer
    io = IOBuffer()
    write(io, output)
    csv = String(take!(io))

                  
    payload = Dataset(;
        name = "autogenerated sim run",
        description = "autogenerated sim run",
        url = "",
        simulation_run = true
    )
    # TODO(five): Handle 4xx from TDS
    response, _ = init_dataset(api, payload)
    response.id
end

end # module AssetManager
